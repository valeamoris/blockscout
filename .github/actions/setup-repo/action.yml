name: 'Setup repo'
description: 'Setup repo: checkout/login/extract metadata, Set up Docker Buildx'
inputs:
  github-token:
    description: 'GitHub token for ghcr.io authentication'
    required: true
  docker-image:
    description: 'Docker image'
    required: true
    default: ghcr.io/valeamoris/blockscout
outputs:
  docker-builder:
    description: 'Docker builder'
    value: ${{ steps.builder_local.outputs.name }}
  docker-tags:
    description: 'Docker metadata tags'
    value: ${{ steps.meta.outputs.tags }}
  docker-labels:
    description: 'Docker metadata labels'
    value: ${{ steps.meta.outputs.labels }}
  docker-platforms:
    description: 'Docker build platforms'
    value: ${{ steps.builder_local.outputs.platforms }}
runs:
  using: "composite"
  steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      id: builder_local
      with:
        platforms: linux/amd64

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.repository_owner }}
        password: ${{ inputs.github-token }}

    - name: Extract metadata (tags, labels) for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ inputs.docker-image }}

    - name: Add SHORT_SHA env property with commit short sha
      shell: bash
      run: echo "SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-8`" >> $GITHUB_ENV
